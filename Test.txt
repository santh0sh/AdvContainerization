<%@ page import="java.net.*, java.io.*" %>
<%@ page import="org.apache.commons.fileupload.FileItem" %>

// Assuming you already have fileItem and loggedInUser from parsing the request

<%
    String uploadUrl = "https://your-domain.com/bulkupload/upload/excel"; // Replace with your actual URL
    String boundary = "===" + System.currentTimeMillis() + "===";
    String LINE_FEED = "\r\n";
    String charset = "UTF-8";

    HttpURLConnection connection = (HttpURLConnection) new URL(uploadUrl).openConnection();
    connection.setDoOutput(true);
    connection.setDoInput(true);
    connection.setUseCaches(false);
    connection.setRequestMethod("POST");
    connection.setRequestProperty("Content-Type", "multipart/form-data; boundary=" + boundary);

    OutputStream outputStream = connection.getOutputStream();
    PrintWriter writer = new PrintWriter(new OutputStreamWriter(outputStream, charset), true);

    // --- File part ---
    writer.append("--").append(boundary).append(LINE_FEED);
    writer.append("Content-Disposition: form-data; name=\"file\"; filename=\"" + fileItem.getName() + "\"").append(LINE_FEED);
    writer.append("Content-Type: application/octet-stream").append(LINE_FEED);
    writer.append(LINE_FEED).flush();

    InputStream inputStream = fileItem.getInputStream();
    byte[] buffer = new byte[4096];
    int bytesRead;
    while ((bytesRead = inputStream.read(buffer)) != -1) {
        outputStream.write(buffer, 0, bytesRead);
    }
    inputStream.close();
    outputStream.flush();
    writer.append(LINE_FEED).flush();

    // --- loggedInUser field ---
    writer.append("--").append(boundary).append(LINE_FEED);
    writer.append("Content-Disposition: form-data; name=\"loggedInUser\"").append(LINE_FEED);
    writer.append("Content-Type: text/plain; charset=" + charset).append(LINE_FEED);
    writer.append(LINE_FEED);
    writer.append(loggedInUser).append(LINE_FEED).flush();

    // --- End of multipart ---
    writer.append("--").append(boundary).append("--").append(LINE_FEED);
    writer.close();

    // --- Read API response ---
    BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), charset));
    StringBuilder responseJson = new StringBuilder();
    String line;
    while ((line = reader.readLine()) != null) {
        responseJson.append(line);
    }
    reader.close();

    // --- Output the API response ---
    response.setContentType("application/json");
    response.setCharacterEncoding("UTF-8");
    response.getWriter().write(responseJson.toString());
%>
